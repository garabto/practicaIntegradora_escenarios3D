<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Virtual - Primera Persona con Joysticks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        #container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            margin-bottom: 10px;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .subtitle {
            margin-bottom: 30px;
            color: #a0e7ff;
        }
        
        #scene-container {
            width: 100%;
            height: 70vh;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border: 2px solid #00d4ff;
            margin-bottom: 20px;
        }
        
        #renderer {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .controls-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 30px;
            padding: 0 20px;
        }
        
        .joystick-container {
            width: 200px;
            height: 200px;
            position: relative;
        }
        
        .joystick-label {
            margin-bottom: 10px;
            color: #00d4ff;
            font-weight: bold;
        }
        
        .joystick-base {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 3px solid #00d4ff;
            position: relative;
            margin: 0 auto;
            box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.3);
        }
        
        .joystick-handle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #00d4ff 0%, #008cff 100%);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
            transition: transform 0.1s;
        }
        
        .joystick-handle.active {
            background: radial-gradient(circle, #ff416c 0%, #ff4b2b 100%);
            box-shadow: 0 0 20px rgba(255, 65, 108, 0.9);
        }
        
        .controls-info {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-width: 800px;
            border: 1px solid #00d4ff;
        }
        
        .controls-info h3 {
            margin-bottom: 15px;
            color: #00d4ff;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .key {
            display: inline-block;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            padding: 5px 10px;
            margin-right: 10px;
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }
        
        #mobile-warning {
            display: none;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid #ff6464;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-width: 800px;
        }
        
        #mobile-warning h3 {
            color: #ff6464;
            margin-bottom: 10px;
        }
        
        #status {
            margin-top: 15px;
            font-style: italic;
            color: #a0e7ff;
        }
        
        @media (max-width: 768px) {
            .controls-container {
                flex-direction: column;
                align-items: center;
            }
            
            .joystick-container {
                margin-bottom: 30px;
            }
            
            #mobile-warning {
                display: block;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
</head>
<body>
    <div id="container">
        <h1>MUNDO VIRTUAL EN PRIMERA PERSONA</h1>
        <p class="subtitle">Control mediante joysticks - Vista en primera persona</p>
        
        <div id="scene-container">
            <canvas id="renderer"></canvas>
        </div>
        
        <div class="controls-container">
            <div class="joystick-container">
                <div class="joystick-label">Movimiento</div>
                <div class="joystick-base" id="movement-joystick-base">
                    <div class="joystick-handle" id="movement-joystick-handle"></div>
                </div>
            </div>
            
            <div class="joystick-container">
                <div class="joystick-label">Rotación/Vista</div>
                <div class="joystick-base" id="rotation-joystick-base">
                    <div class="joystick-handle" id="rotation-joystick-handle"></div>
                </div>
            </div>
        </div>
        
        <div id="mobile-warning">
            <h3>Nota para dispositivos móviles:</h3>
            <p>Para una mejor experiencia, se recomienda usar un dispositivo con pantalla más grande o un computador de escritorio. En móviles, puedes tocar y arrastrar los joysticks para moverte.</p>
        </div>
        
        <div class="controls-info">
            <h3>Controles Disponibles</h3>
            <div class="controls-grid">
                <div class="control-item">
                    <span class="key">Joystick Izq</span>
                    <span>Movimiento adelante/atrás y lateral</span>
                </div>
                <div class="control-item">
                    <span class="key">Joystick Der</span>
                    <span>Rotar vista y mirar alrededor</span>
                </div>
                <div class="control-item">
                    <span class="key">Click</span>
                    <span>Bloquear/desbloquear cursor</span>
                </div>
                <div class="control-item">
                    <span class="key">ESPACIO</span>
                    <span>Saltar</span>
                </div>
            </div>
            <div id="status">Estado: Esperando interacción...</div>
        </div>
    </div>

    <script>
        // Variables principales
        let scene, camera, renderer, controls;
        let movementJoystick, rotationJoystick;
        let objects = [];
        let isLocked = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let canJump = false;
        let prevTime = performance.now();
        
        // Inicialización de la escena
        function init() {
            // Crear escena
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 10, 150);
            
            // Crear cámara en primera persona
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5);
            
            // Crear renderizador
            const canvas = document.getElementById('renderer');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.parentElement.clientWidth, canvas.parentElement.clientHeight);
            renderer.setClearColor(0x87CEEB);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Configurar controles de puntero (para ratón)
            controls = new THREE.PointerLockControls(camera, canvas);
            scene.add(controls.getObject());
            
            // Configurar joysticks virtuales
            setupJoysticks();
            
            // Configurar luces
            setupLights();
            
            // Crear mundo
            createWorld();
            
            // Configurar eventos
            setupEventListeners();
            
            // Actualizar estado
            updateStatus("Mundo virtual cargado. Haz clic en la pantalla para activar controles.");
            
            // Iniciar animación
            animate();
        }
        
        // Configurar joysticks virtuales
        function setupJoysticks() {
            // Joystick de movimiento
            const movementBase = document.getElementById('movement-joystick-base');
            const movementHandle = document.getElementById('movement-joystick-handle');
            
            // Joystick de rotación
            const rotationBase = document.getElementById('rotation-joystick-base');
            const rotationHandle = document.getElementById('rotation-joystick-handle');
            
            // Variables para rastrear estado de joysticks
            movementJoystick = {
                active: false,
                x: 0,
                y: 0,
                base: movementBase,
                handle: movementHandle
            };
            
            rotationJoystick = {
                active: false,
                x: 0,
                y: 0,
                base: rotationBase,
                handle: rotationHandle
            };
            
            // Configurar eventos táctiles/ratón para joystick de movimiento
            setupJoystickEvents(movementJoystick, 'movement');
            
            // Configurar eventos táctiles/ratón para joystick de rotación
            setupJoystickEvents(rotationJoystick, 'rotation');
        }
        
        // Configurar eventos para un joystick
        function setupJoystickEvents(joystick, type) {
            const baseRect = joystick.base.getBoundingClientRect();
            const centerX = baseRect.left + baseRect.width / 2;
            const centerY = baseRect.top + baseRect.height / 2;
            const maxDistance = baseRect.width / 2 - joystick.handle.offsetWidth / 2;
            
            function updateJoystickPosition(clientX, clientY) {
                const dx = clientX - centerX;
                const dy = clientY - centerY;
                const distance = Math.min(Math.sqrt(dx * dx + dy * dy), maxDistance);
                
                // Calcular ángulo y posición normalizada
                const angle = Math.atan2(dy, dx);
                joystick.x = Math.cos(angle) * (distance / maxDistance);
                joystick.y = Math.sin(angle) * (distance / maxDistance);
                
                // Actualizar posición visual del handle
                joystick.handle.style.transform = `translate(-50%, -50%) translate(${joystick.x * maxDistance}px, ${joystick.y * maxDistance}px)`;
                
                // Activar visualmente
                joystick.handle.classList.add('active');
                joystick.active = true;
            }
            
            function resetJoystick() {
                joystick.x = 0;
                joystick.y = 0;
                joystick.active = false;
                joystick.handle.style.transform = 'translate(-50%, -50%)';
                joystick.handle.classList.remove('active');
            }
            
            // Eventos para ratón
            joystick.base.addEventListener('mousedown', function(e) {
                updateJoystickPosition(e.clientX, e.clientY);
                
                const mouseMoveHandler = function(e) {
                    updateJoystickPosition(e.clientX, e.clientY);
                };
                
                const mouseUpHandler = function() {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    resetJoystick();
                };
                
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            });
            
            // Eventos para pantalla táctil
            joystick.base.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (e.touches.length > 0) {
                    const touch = e.touches[0];
                    updateJoystickPosition(touch.clientX, touch.clientY);
                }
            });
            
            joystick.base.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (e.touches.length > 0) {
                    const touch = e.touches[0];
                    updateJoystickPosition(touch.clientX, touch.clientY);
                }
            });
            
            joystick.base.addEventListener('touchend', function(e) {
                e.preventDefault();
                resetJoystick();
            });
            
            joystick.base.addEventListener('touchcancel', function(e) {
                e.preventDefault();
                resetJoystick();
            });
        }
        
        // Configurar luces de la escena
        function setupLights() {
            // Luz ambiental
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            // Luz direccional (sol)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
        }
        
        // Crear el mundo virtual
        function createWorld() {
            // Crear suelo
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3a7c3a,
                side: THREE.DoubleSide
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Crear objetos en el mundo
            const cubeGeometry = new THREE.BoxGeometry(2, 2, 2);
            const sphereGeometry = new THREE.SphereGeometry(1, 32, 32);
            const cylinderGeometry = new THREE.CylinderGeometry(1, 1, 3, 32);
            
            const materials = [
                new THREE.MeshLambertMaterial({ color: 0xff4444 }),
                new THREE.MeshLambertMaterial({ color: 0x44ff44 }),
                new THREE.MeshLambertMaterial({ color: 0x4444ff }),
                new THREE.MeshLambertMaterial({ color: 0xffff44 }),
                new THREE.MeshLambertMaterial({ color: 0xff44ff }),
                new THREE.MeshLambertMaterial({ color: 0x44ffff })
            ];
            
            // Crear varios objetos distribuidos en el mundo
            for (let i = 0; i < 20; i++) {
                let mesh;
                const material = materials[Math.floor(Math.random() * materials.length)];
                
                switch (i % 3) {
                    case 0:
                        mesh = new THREE.Mesh(cubeGeometry, material);
                        break;
                    case 1:
                        mesh = new THREE.Mesh(sphereGeometry, material);
                        break;
                    case 2:
                        mesh = new THREE.Mesh(cylinderGeometry, material);
                        break;
                }
                
                mesh.position.x = (Math.random() - 0.5) * 80;
                mesh.position.z = (Math.random() - 0.5) * 80;
                mesh.position.y = mesh.geometry.type === 'SphereGeometry' ? 1 : mesh.geometry.parameters.height / 2;
                
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                
                scene.add(mesh);
                objects.push(mesh);
            }
            
            // Crear árboles
            const treeTrunkGeometry = new THREE.CylinderGeometry(0.3, 0.5, 3, 8);
            const treeTopGeometry = new THREE.ConeGeometry(2, 4, 8);
            
            for (let i = 0; i < 15; i++) {
                const trunkMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                const trunk = new THREE.Mesh(treeTrunkGeometry, trunkMaterial);
                
                const topMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
                const top = new THREE.Mesh(treeTopGeometry, topMaterial);
                top.position.y = 2.5;
                
                const tree = new THREE.Group();
                tree.add(trunk);
                tree.add(top);
                
                tree.position.x = (Math.random() - 0.5) * 90;
                tree.position.z = (Math.random() - 0.5) * 90;
                tree.position.y = 1.5;
                
                trunk.castShadow = true;
                trunk.receiveShadow = true;
                top.castShadow = true;
                top.receiveShadow = true;
                
                scene.add(tree);
                objects.push(tree);
            }
        }
        
        // Configurar eventos
        function setupEventListeners() {
            const canvas = document.getElementById('renderer');
            
            // Bloquear/desbloquear puntero al hacer clic
            canvas.addEventListener('click', function() {
                if (!isLocked) {
                    canvas.requestPointerLock();
                    updateStatus("Controles activados. Usa los joysticks o teclas WASD para moverte.");
                }
            });
            
            // Eventos de bloqueo/desbloqueo de puntero
            document.addEventListener('pointerlockchange', pointerLockChange);
            document.addEventListener('mozpointerlockchange', pointerLockChange);
            
            // Eventos de teclado para movimiento adicional
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            
            // Redimensionar ventana
            window.addEventListener('resize', onWindowResize);
        }
        
        // Manejar cambio de bloqueo de puntero
        function pointerLockChange() {
            isLocked = document.pointerLockElement === renderer.domElement ||
                      document.mozPointerLockElement === renderer.domElement;
            
            if (isLocked) {
                updateStatus("Controles activados. Usa los joysticks o teclas WASD para moverte.");
            } else {
                updateStatus("Controles desactivados. Haz clic en la pantalla para activar.");
            }
        }
        
        // Manejar teclas presionadas
        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW':
                    moveForward = true;
                    break;
                case 'KeyS':
                    moveBackward = true;
                    break;
                case 'KeyA':
                    moveLeft = true;
                    break;
                case 'KeyD':
                    moveRight = true;
                    break;
                case 'Space':
                    if (canJump) {
                        velocity.y = 10;
                        canJump = false;
                    }
                    break;
            }
        }
        
        // Manejar teclas liberadas
        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW':
                    moveForward = false;
                    break;
                case 'KeyS':
                    moveBackward = false;
                    break;
                case 'KeyA':
                    moveLeft = false;
                    break;
                case 'KeyD':
                    moveRight = false;
                    break;
            }
        }
        
        // Redimensionar ventana
        function onWindowResize() {
            const container = document.getElementById('scene-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Actualizar estado en la interfaz
        function updateStatus(message) {
            document.getElementById('status').textContent = `Estado: ${message}`;
        }
        
        // Animar la escena
        function animate() {
            requestAnimationFrame(animate);
            
            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            
            // Actualizar movimiento según joysticks y teclas
            direction.z = 0;
            direction.x = 0;
            
            // Movimiento basado en joystick de movimiento
            if (movementJoystick.active) {
                direction.z = -movementJoystick.y * 20.0 * delta;
                direction.x = -movementJoystick.x * 20.0 * delta;
            }
            
            // Movimiento basado en teclas (compatibilidad)
            if (moveForward) direction.z -= 20.0 * delta;
            if (moveBackward) direction.z += 20.0 * delta;
            if (moveLeft) direction.x -= 20.0 * delta;
            if (moveRight) direction.x += 20.0 * delta;
            
            // Rotación basada en joystick de rotación
            if (rotationJoystick.active && isLocked) {
                controls.getObject().rotation.y -= rotationJoystick.x * 0.05;
                camera.rotation.x = THREE.MathUtils.clamp(
                    camera.rotation.x - rotationJoystick.y * 0.02, 
                    -Math.PI/2, 
                    Math.PI/2
                );
            }
            
            // Aplicar movimiento si hay dirección
            if (direction.length() > 0) {
                direction.normalize();
                
                // Mover hacia adelante/atrás
                if (direction.z !== 0) {
                    velocity.z = direction.z * 400.0 * delta;
                }
                
                // Mover lateralmente
                if (direction.x !== 0) {
                    velocity.x = direction.x * 400.0 * delta;
                }
                
                // Aplicar velocidad al controlador
                controls.moveRight(velocity.x * delta);
                controls.moveForward(velocity.z * delta);
                
                // Reducir velocidad gradualmente
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
            }
            
            // Aplicar gravedad
            velocity.y -= 9.8 * 100.0 * delta;
            
            // Verificar colisión con el suelo (simplificado)
            const cameraHeight = controls.getObject().position.y;
            if (cameraHeight <= 1.6) {
                velocity.y = 0;
                controls.getObject().position.y = 1.6;
                canJump = true;
            }
            
            // Mover en eje Y
            controls.getObject().position.y += velocity.y * delta;
            
            prevTime = time;
            
            // Renderizar escena
            renderer.render(scene, camera);
        }
        
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
